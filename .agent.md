# Secure Notes Sync - VS Code Extension

## Project Overview

**Purpose**: A Visual Studio Code extension for securely managing and synchronizing notes (or other files) with a GitHub repository using AES encryption and branch-based version control.

**Language**: TypeScript  
**Framework**: VS Code Extension API  
**Build System**: Webpack + TypeScript  
**Testing**: VS Code Test Framework with Mocha  
**License**: See [LICENSE](LICENSE)

## Key Features

- **ðŸ”’ Secure Sync**: Encrypt files with AES-256-CBC before syncing to GitHub
- **ðŸŒ¿ Branch Management**: Create and switch between branches for different development lines
- **âš¡ Auto-Sync**: Optional sync on save or after periods of inactivity
- **ðŸ”‘ AES Key Management**: Generate keys, retrieve from 1Password CLI, or manual input
- **ðŸ”„ Conflict Resolution**: Detect and resolve merge conflicts automatically
- **ðŸŒ³ Tree View**: Visualize branches and historical indexes in the activity bar

## Project Structure

### Core Files
- `src/extension.ts` - Main extension entry point with command registration and activation logic
- `src/SyncService.ts` - Core synchronization service with incremental sync logic
- `src/types.ts` - TypeScript interfaces for FileEntry, IndexFile, and other core types
- `src/spec.md` - Detailed technical specification
- `src/logger.ts` - Custom terminal-based logging with ANSI colors

### Storage Layer
- `src/storage/IStorageProvider.ts` - Interface for storage providers
- `src/storage/GithubProvider.ts` - GitHub-based storage implementation
- `src/storage/LocalObjectManager.ts` - Local file encryption, indexing, and workspace management

### UI Components
- `src/BranchTreeViewProvider.ts` - Tree view provider for branch and index visualization

### Test Files
- `src/test/extension.test.ts` - Basic extension functionality tests
- `src/test/SyncService.test.ts` - Comprehensive sync service tests with mocks
- `.vscode-test.mjs` - VS Code test runner configuration

### Configuration Files
- `package.json` - Extension manifest with commands, views, and configuration schema
- `webpack.config.js` - Build configuration for bundling
- `tsconfig.json` - TypeScript compiler configuration
- `eslint.config.mjs` - ESLint configuration with TypeScript rules

## Architecture Patterns

### Encryption Strategy
- **Algorithm**: AES-256-CBC with random IV per file
- **Key Management**: 64-character hex strings (32 bytes)
- **Storage**: Encrypted files stored in `.secureNotes/remotes/files/` with hash-based paths
- **Integrity**: SHA-256 hashing for file verification

### Version Control Model
- **Index Files**: JSON structures with UUID v7, parent references, and file metadata
- **Branch References**: Encrypted UUID pointers stored in `.secureNotes/remotes/refs/`
- **Workspace Index**: `wsIndex.json` tracks current workspace state
- **HEAD File**: `.secureNotes/HEAD` stores current branch name

### File Organization
```
.secureNotes/
â”œâ”€â”€ HEAD                           # Current branch name
â”œâ”€â”€ wsIndex.json                   # Current workspace index
â””â”€â”€ remotes/
    â”œâ”€â”€ refs/                      # Branch references (encrypted UUIDs)
    â”œâ”€â”€ indexes/                   # Encrypted index files (UUID-based paths)
    â””â”€â”€ files/                     # Encrypted file content (hash-based paths)
```

### Dependency Injection Pattern
The `SyncService` uses dependency injection for testability:
```typescript
interface SyncDependencies {
  localObjectManager: typeof LocalObjectManager;
  gitHubSyncProvider: GitHubSyncProvider;
  branchProvider: BranchTreeViewProvider;
}
```

## Development Guidelines

### Code Style
- Use TypeScript strict mode with all strict type-checking options enabled
- Follow ESLint rules defined in `eslint.config.mjs`
- Use Prettier for formatting (2-space indentation, semicolons)
- Prefer `async/await` over Promises
- Use meaningful variable names and add JSDoc comments for public APIs

### Error Handling
- Use the logger module for consistent error reporting
- Show user-friendly error messages via `showError()` function
- Log detailed error information for debugging
- Always handle async operations with try-catch blocks
- Provide fallback mechanisms for critical operations

### VS Code Extension Patterns
- Register commands in `activate()` function
- Use `context.subscriptions.push()` for proper cleanup
- Leverage VS Code's workspace API for file operations
- Use secrets API for sensitive data (AES keys)
- Implement proper activation events in `package.json`

### Storage Conventions
- Hash-based file paths: first 2 characters as directory, remainder as filename
- UUID-based index paths: first 6 characters as directory, remainder as filename
- Always encrypt sensitive data before storage
- Use relative paths for workspace files
- Validate file integrity with SHA-256 hashes

### Testing Best Practices
- Use mock objects to isolate units under test
- Test both success and failure scenarios
- Mock external dependencies (VS Code API, file system, GitHub)
- Use descriptive test names that explain the scenario
- Clean up mocks in `teardown()` functions

## Configuration Schema

### Required Settings
- `SecureNotesSync.gitRemoteUrl` - GitHub repository URL (e.g., `git@github.com:user/repo.git`)

### Optional Settings
- `SecureNotesSync.enableAutoSync` - Enable automatic sync (default: false)
- `SecureNotesSync.inactivityTimeoutSec` - Auto-sync timeout (default: 60)
- `SecureNotesSync.saveSyncTimeoutSec` - Delay after save before sync (default: 5)
- `SecureNotesSync.onePasswordUri` - 1Password CLI URI for key retrieval
- `SecureNotesSync.onePasswordAccount` - 1Password account name
- `SecureNotesSync.onePasswordCacheTimeout` - Key cache duration (default: "30d")

## Commands Available

### Core Operations
- `extension.generateAESKey` - Generate new 32-byte AES key
- `extension.setAESKey` - Manually set AES key
- `extension.syncNotes` - Manual sync with GitHub
- `extension.refreshAESKey` - Force refresh from 1Password

### Utility Commands
- `extension.copyAESKeyToClipboard` - Copy current key to clipboard
- `extension.insertCurrentTime` - Insert timestamp in active editor

### Branch Management
- `extension.createBranchFromIndex` - Create new branch from selected index
- `extension.checkoutBranch` - Switch to selected branch

## Testing Strategy

### Test Structure
- **Unit Tests**: Test individual components in isolation
- **Integration Tests**: Test component interactions
- **Mock Strategy**: Mock external dependencies for reliable testing

### Test Files
- `src/test/extension.test.ts` - Basic extension functionality tests
- `src/test/SyncService.test.ts` - Comprehensive sync service tests with scenarios:
  - Incremental sync with no remote updates
  - Incremental sync with remote updates
  - Conflict detection and resolution
  - Error handling and recovery
  - File update scenarios

### Test Configuration
- `.vscode-test.mjs` - VS Code test runner configuration with headless support
- Tests run in isolated VS Code instance with disabled extensions

### Test Commands
```bash
pnpm run compile-tests    # Compile test files
pnpm run pretest         # Run linting and compilation
pnpm run test            # Execute tests with VS Code test runner
pnpm run test:sync       # Alternative test runner for sync service
pnpm run test:headless   # Execute tests in headless environment (recommended)
```

### Running Tests in Headless Environment
**Recommended for development and CI/CD:**
```bash
# Install xvfb if not already installed
sudo apt-get install xvfb

# Run tests in headless mode (preferred method)
pnpm run test:headless

# Or run directly with xvfb
xvfb-run -a pnpm run test
```

**Note:** Always use headless mode for automated testing and CI/CD pipelines to avoid display-related issues.

### CI/CD Configuration
For GitHub Actions or other CI/CD systems:
```yaml
# Example GitHub Actions step
- name: Install xvfb
  run: sudo apt-get update && sudo apt-get install -y xvfb

- name: Run tests
  run: pnpm run test:headless
```

For Docker environments:
```dockerfile
# Install xvfb in your Docker image
RUN apt-get update && apt-get install -y xvfb

# Use headless testing
CMD ["pnpm", "run", "test:headless"]
```

## Build and Development

### Development Workflow
```bash
pnpm install             # Install dependencies
pnpm run compile         # Build for development
pnpm run watch           # Watch mode for development
F5                      # Launch extension in new VS Code window
```

### Testing Best Practices
- **Always use headless mode**: `pnpm run test:headless` for consistent results
- **Test isolation**: Each test should be independent and clean up after itself
- **Mock external dependencies**: Use mocks for VS Code API, file system, and GitHub operations
- **Environment setup**: Ensure proper workspace and context mocking for LocalObjectManager tests

### Production Build
```bash
pnpm run package         # Build optimized bundle
pnpm run vscode:prepublish # Prepare for publishing
```

### Dependencies
- **Runtime**: `uuid` (UUID generation), `which` (CLI tool detection)
- **Development**: TypeScript, Webpack, ESLint, VS Code types, Mocha

## Security Considerations

### Key Management
- Never log or expose AES keys in plain text
- Use VS Code secrets API for secure storage
- Support 1Password CLI integration for enterprise environments
- Implement key caching with configurable timeouts
- Validate key format (64 hex characters) before use

### File Encryption
- Generate random IV for each file encryption
- Use SHA-256 for file integrity verification
- Encrypt all sensitive data before GitHub storage
- Implement secure key derivation if needed

### Git Integration
- Use SSH keys for GitHub authentication
- Never commit unencrypted sensitive data
- Implement proper conflict resolution strategies
- Validate remote repository URLs

## Troubleshooting

### Common Issues
- **AES Key not set**: Run "Generate AES Key" or "Set AES Key" command
- **Git remote not configured**: Set `gitRemoteUrl` in extension settings
- **1Password CLI issues**: Ensure `op` is in PATH and properly authenticated
- **Sync conflicts**: Extension automatically resolves with conflict file creation
- **Test failures**: Always use `pnpm run test:headless` to avoid display-related issues
- **Display errors**: Use headless mode (`xvfb-run -a`) for all automated testing
- **Workspace not found errors**: Ensure proper workspace mocking in test setup

### Debug Information
- Check the "SecureNoteSync Log" terminal for detailed logs
- Use VS Code Developer Tools for extension debugging
- Verify `.secureNotes` directory structure and permissions
- Check Git configuration and SSH key setup
- For test debugging: Use `console.log` in test files and run `pnpm run test:headless`
- Monitor test output for specific error patterns and mock setup issues

### Performance Considerations
- Large file handling: Consider chunking for very large files
- Network timeouts: Implement retry logic for GitHub operations
- Memory usage: Monitor memory consumption during sync operations

## Extension Activation

The extension activates when a workspace contains `.secureNotes/wsIndex.json`, indicating an initialized secure notes repository.

## Contributing

### Development Setup
1. Clone the repository
2. Run `pnpm install`
3. Open in VS Code
4. Press F5 to launch extension development host

### Code Quality
- All code must pass ESLint checks
- Add tests for new functionality
- Update documentation for API changes
- Follow existing code patterns and conventions

### Pull Request Guidelines
- Include tests for new features
- Update relevant documentation
- Ensure all tests pass
- Follow conventional commit messages