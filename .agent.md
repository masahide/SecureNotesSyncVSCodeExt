# Secure Notes Sync - VS Code Extension

## Project Overview

**Purpose**: A Visual Studio Code extension for securely managing and synchronizing notes (or other files) with a GitHub repository using AES encryption and branch-based version control.

**Language**: TypeScript  
**Framework**: VS Code Extension API  
**Build System**: Webpack + TypeScript  
**Testing**: VS Code Test Framework with Mocha  
**License**: See [LICENSE](LICENSE)

## Key Features

- **üîí Secure Sync**: Encrypt files with AES-256-CBC before syncing to GitHub
- **üåø Branch Management**: Create and switch between branches for different development lines
- **‚ö° Auto-Sync**: Optional sync on save or after periods of inactivity
- **üîë AES Key Management**: Generate keys, retrieve from 1Password CLI, or manual input
- **üîÑ Conflict Resolution**: Detect and resolve merge conflicts automatically
- **üå≥ Tree View**: Visualize branches and historical indexes in the activity bar
- **üèóÔ∏è Dependency Injection**: Modern DI container for testable and maintainable code
- **üìã Index History**: View and navigate through historical index states

## Project Structure

### Core Files
- `src/extension.ts` - Main extension entry point with command registration and activation logic
- `src/SyncService.ts` - Core synchronization service with incremental sync logic
- `src/types.ts` - TypeScript interfaces for FileEntry, IndexFile, and other core types
- `src/config.ts` - Configuration utilities and settings management
- `src/logger.ts` - Custom terminal-based logging with ANSI colors

### Dependency Injection Container
- `src/container/ServiceContainer.ts` - Core DI container with lifecycle management
- `src/container/ContainerBuilder.ts` - Fluent builder for container configuration
- `src/container/ServiceLocator.ts` - Global service locator pattern implementation
- `src/container/ServiceKeys.ts` - Type-safe service key constants

### Interfaces & Abstractions
- `src/interfaces/ISyncService.ts` - Sync service interface for testability
- `src/interfaces/ISyncServiceFactory.ts` - Factory interface with configuration types

### Factories
- `src/factories/SyncServiceFactory.ts` - Factory for creating sync services with dependencies

### Configuration Management
- `src/config/ConfigManager.ts` - Centralized configuration management with validation

### Storage Layer
- `src/storage/IStorageProvider.ts` - Interface for storage providers
- `src/storage/GithubProvider.ts` - GitHub-based storage implementation
- `src/storage/LocalObjectManager.ts` - Local file encryption, indexing, and workspace management

### UI Components
- `src/BranchTreeViewProvider.ts` - Tree view provider for branch and index visualization
- `src/IndexHistoryProvider.ts` - Tree view provider for index history navigation

### Test Files
- `src/test/extension.test.ts` - Basic extension functionality tests
- `src/test/SyncService.test.ts` - Comprehensive sync service tests with mocks
- `src/test/LocalObjectManager.test.ts` - Local object manager unit tests
- `src/test/GitHubProvider.test.ts` - GitHub provider unit tests
- `src/test/integration.test.ts` - Integration tests for end-to-end scenarios
- `src/test/unit-test.ts` - Fast unit test runner
- `src/test/alternative-test-runner.ts` - Alternative test execution
- `src/test/manual-sync-test.ts` - Manual sync testing utilities
- `.vscode-test.mjs` - VS Code test runner configuration

### Configuration Files
- `package.json` - Extension manifest with commands, views, and configuration schema
- `webpack.config.js` - Build configuration for bundling
- `tsconfig.json` - TypeScript compiler configuration
- `eslint.config.mjs` - ESLint configuration with TypeScript rules

### Documentation
- `docs/spec.md` - Detailed technical specification in Japanese
- `docs/source-code-mapping.md` - Source code structure mapping
- `docs/sync-process-detailed-analysis.md` - Detailed sync process analysis
- `docs/architecture-update-summary.md` - Architecture update overview and migration guide

## Architecture Patterns

### Dependency Injection Architecture
The extension now uses a modern DI container pattern for better testability and maintainability:

#### Service Container
- **ServiceContainer**: Core DI container with singleton, scoped, and transient lifetimes
- **ContainerBuilder**: Fluent builder pattern for container configuration
- **ServiceLocator**: Global service access point with type safety
- **ServiceKeys**: Centralized service key constants for type safety

#### Service Lifecycle Management
```typescript
// Singleton services (shared across extension lifetime)
- ConfigManager
- LocalObjectManager
- SyncServiceFactory

// Scoped services (per operation)
- SyncService instances

// Transient services (new instance each time)
- GitHubSyncProvider (depends on configuration)
```

#### Factory Pattern
```typescript
interface ISyncServiceFactory {
  createSyncService(config: SyncConfig): ISyncService;
  createStorageProvider(config: StorageConfig, encryptionKey: string): IStorageProvider;
}
```

### Encryption Strategy
- **Algorithm**: AES-256-CBC with random IV per file
- **Key Management**: 64-character hex strings (32 bytes)
- **Storage**: Encrypted files stored in `.secureNotes/remotes/files/` with hash-based paths
- **Integrity**: SHA-256 hashing for file verification

### Version Control Model
- **Index Files**: JSON structures with UUID v7, parent references, and file metadata
- **Branch References**: Encrypted UUID pointers stored in `.secureNotes/remotes/refs/`
- **Workspace Index**: `wsIndex.json` tracks current workspace state
- **HEAD File**: `.secureNotes/HEAD` stores current branch name
- **Environment ID**: Unique identifier per machine/environment for conflict resolution

### File Organization
```
.secureNotes/
‚îú‚îÄ‚îÄ HEAD                           # Current branch name
‚îú‚îÄ‚îÄ wsIndex.json                   # Current workspace index
‚îî‚îÄ‚îÄ remotes/
    ‚îú‚îÄ‚îÄ refs/                      # Branch references (encrypted UUIDs)
    ‚îú‚îÄ‚îÄ indexes/                   # Encrypted index files (UUID-based paths)
    ‚îî‚îÄ‚îÄ files/                     # Encrypted file content (hash-based paths)
```

### Configuration Management
- **ConfigManager**: Centralized configuration with validation
- **Environment ID**: Auto-generated unique identifier per machine (hostname + UUID)
- **Storage Configuration**: Abstracted storage provider configuration
- **Sync Configuration**: Unified configuration for sync operations
- **Configuration Validation**: Automatic validation of encryption keys and remote URLs

### Development Guidelines

### Code Style
- Use TypeScript strict mode with all strict type-checking options enabled
- Follow ESLint rules defined in `eslint.config.mjs`
- Use Prettier for formatting (2-space indentation, semicolons)
- Prefer `async/await` over Promises
- Use meaningful variable names and add JSDoc comments for public APIs
- Follow dependency injection patterns for better testability

### Error Handling
- Use the logger module for consistent error reporting
- Show user-friendly error messages via `showError()` function
- Log detailed error information for debugging
- Always handle async operations with try-catch blocks
- Provide fallback mechanisms for critical operations

### VS Code Extension Patterns
- Register commands in `activate()` function
- Use `context.subscriptions.push()` for proper cleanup
- Leverage VS Code's workspace API for file operations
- Use secrets API for sensitive data (AES keys)
- Implement proper activation events in `package.json`
- Use dependency injection container for service management

### Dependency Injection Best Practices
- Register services with appropriate lifetimes (Singleton, Scoped, Transient)
- Use interfaces for better testability and abstraction
- Leverage the ServiceLocator for global service access
- Use ContainerBuilder for fluent service registration
- Mock dependencies in tests using the container system

### Storage Conventions
- Hash-based file paths: first 2 characters as directory, remainder as filename
- UUID-based index paths: first 6 characters as directory, remainder as filename
- Always encrypt sensitive data before storage
- Use relative paths for workspace files
- Validate file integrity with SHA-256 hashes

### Testing Best Practices
- Use mock objects to isolate units under test
- Test both success and failure scenarios
- Mock external dependencies (VS Code API, file system, GitHub)
- Use descriptive test names that explain the scenario
- Clean up mocks in `teardown()` functions
- Leverage dependency injection for easier mocking
- Use the container system for test service registration
- Prefer fast unit tests (`npm run test:unit`) for rapid development
- Use integration tests for end-to-end scenarios

### Modern Architecture Benefits
- **Improved Testability**: Dependency injection enables easy mocking and unit testing
- **Better Maintainability**: Clear separation of concerns and single responsibility principle
- **Enhanced Extensibility**: Plugin-like architecture for storage providers and services
- **Type Safety**: Interface-driven design with comprehensive TypeScript typing
- **Error Resilience**: Centralized error handling and validation patterns

### Service Registration Pattern
```typescript
// Example service registration in ContainerBuilder
const container = new ContainerBuilder()
  .registerCoreServices()           // ConfigManager, LocalObjectManager, etc.
  .registerVSCodeServices(context)  // Extension context, UI providers
  .registerStorageServices()        // GitHub provider, future S3/local providers
  .registerSyncServices()           // SyncService with factory pattern
  .build();

ServiceLocator.setContainer(container);
```

### Interface-First Development
All major components implement well-defined interfaces:
- `ISyncService` for synchronization operations
- `ISyncServiceFactory` for service creation
- `IStorageProvider` for storage abstraction
- Enables easy testing, mocking, and future extensions

## Configuration Schema

### Required Settings
- `SecureNotesSync.gitRemoteUrl` - GitHub repository URL (e.g., `git@github.com:user/repo.git`)

### Optional Settings
- `SecureNotesSync.enableAutoSync` - Enable automatic sync (default: false)
- `SecureNotesSync.inactivityTimeoutSec` - Auto-sync timeout (default: 60)
- `SecureNotesSync.saveSyncTimeoutSec` - Delay after save before sync (default: 5)
- `SecureNotesSync.onePasswordUri` - 1Password CLI URI for key retrieval
- `SecureNotesSync.onePasswordAccount` - 1Password account name
- `SecureNotesSync.onePasswordCacheTimeout` - Key cache duration (default: "30d")

### Commands Available

### Core Operations
- `secureNotes.sync` - Manual sync with GitHub
- `secureNotes.initializeNewRepository` - Initialize new repository
- `secureNotes.importExistingRepository` - Import existing repository
- `secureNotes.previewIndex` - Preview index content

### AES Key Management
- `secureNotes.generateAESKey` - Generate new 32-byte AES key
- `secureNotes.setAESKey` - Manually set AES key
- `secureNotes.copyAESKeyToClipboard` - Copy current key to clipboard
- `secureNotes.refreshAESKey` - Force refresh from 1Password

### Branch Management
- `secureNotes.createBranchFromIndex` - Create new branch from selected index
- `secureNotes.checkoutBranch` - Switch to selected branch

### Utility Commands
- `secureNotes.insertCurrentTime` - Insert timestamp in active editor

## Testing Strategy

### Test Structure
- **Unit Tests**: Test individual components in isolation
- **Integration Tests**: Test component interactions
- **Mock Strategy**: Mock external dependencies for reliable testing

### Test Files
- `src/test/extension.test.ts` - Basic extension functionality tests
- `src/test/SyncService.test.ts` - Comprehensive sync service tests with scenarios:
  - Incremental sync with no remote updates
  - Incremental sync with remote updates
  - Conflict detection and resolution
  - Error handling and recovery
  - File update scenarios

### Test Configuration
- `.vscode-test.mjs` - VS Code test runner configuration with headless support
- Tests run in isolated VS Code instance with disabled extensions

### Test Commands
```bash
npm run compile-tests    # Compile test files
npm run pretest         # Run linting and compilation
npm run test            # Execute tests with VS Code test runner (headless)
npm run test:headless   # Execute tests in headless environment (recommended)
npm run test:local      # Execute tests with local VS Code instance
npm run test:sync       # Alternative test runner for sync service
npm run test:unit       # Fast unit tests with tsx
npm run test:fast       # Quick test run (unit tests + linting)
npm run test:incremental # Incremental test compilation
```

### Running Tests in Headless Environment
**Recommended for development and CI/CD:**
```bash
# Install xvfb if not already installed
sudo apt-get install xvfb

# Run tests in headless mode (preferred method)
npm run test:headless

# Or run directly with xvfb
xvfb-run -a npm run test
```

**Note:** Always use headless mode for automated testing and CI/CD pipelines to avoid display-related issues.

### CI/CD Configuration
For GitHub Actions or other CI/CD systems:
```yaml
# Example GitHub Actions step
- name: Install xvfb
  run: sudo apt-get update && sudo apt-get install -y xvfb

- name: Run tests
  run: npm run test:headless
```

For Docker environments:
```dockerfile
# Install xvfb in your Docker image
RUN apt-get update && apt-get install -y xvfb

# Use headless testing
CMD ["npm", "run", "test:headless"]
```

## Build and Development

### Development Workflow
```bash
npm install             # Install dependencies
npm run compile         # Build for development
npm run watch           # Watch mode for development
F5                      # Launch extension in new VS Code window
```

### Testing Best Practices
- **Always use headless mode**: `npm run test:headless` for consistent results
- **Test isolation**: Each test should be independent and clean up after itself
- **Mock external dependencies**: Use mocks for VS Code API, file system, and GitHub operations
- **Environment setup**: Ensure proper workspace and context mocking for LocalObjectManager tests

### Production Build
```bash
npm run package         # Build optimized bundle
npm run vscode:prepublish # Prepare for publishing
```

### Dependencies
- **Runtime**: `uuid` (UUID generation), `which` (CLI tool detection)
- **Development**: TypeScript, Webpack, ESLint, VS Code types, Mocha, tsx (fast TypeScript execution)

## Security Considerations

### Key Management
- Never log or expose AES keys in plain text
- Use VS Code secrets API for secure storage
- Support 1Password CLI integration for enterprise environments
- Implement key caching with configurable timeouts
- Validate key format (64 hex characters) before use

### File Encryption
- Generate random IV for each file encryption
- Use SHA-256 for file integrity verification
- Encrypt all sensitive data before GitHub storage
- Implement secure key derivation if needed

### Git Integration
- Use SSH keys for GitHub authentication
- Never commit unencrypted sensitive data
- Implement proper conflict resolution strategies
- Validate remote repository URLs

## Troubleshooting

### Common Issues
- **AES Key not set**: Run "Generate AES Key" or "Set AES Key" command
- **Git remote not configured**: Set `gitRemoteUrl` in extension settings
- **1Password CLI issues**: Ensure `op` is in PATH and properly authenticated
- **Sync conflicts**: Extension automatically resolves with conflict file creation
- **Test failures**: Always use `npm run test:headless` to avoid display-related issues
- **Display errors**: Use headless mode (`xvfb-run -a`) for all automated testing
- **Workspace not found errors**: Ensure proper workspace mocking in test setup
- **Service resolution errors**: Check ServiceLocator initialization and container setup
- **Configuration validation errors**: Verify encryption key format (64 hex chars) and remote URL

### Dependency Injection Troubleshooting
- **Service not registered**: Check ContainerBuilder configuration and service keys
- **Circular dependencies**: Review service registration order and dependencies
- **Lifetime issues**: Verify appropriate service lifetimes (Singleton/Scoped/Transient)
- **Mock setup failures**: Ensure proper container configuration in test setup

### Debug Information
- Check the "SecureNoteSync Log" terminal for detailed logs
- Use VS Code Developer Tools for extension debugging
- Verify `.secureNotes` directory structure and permissions
- Check Git configuration and SSH key setup
- For test debugging: Use `console.log` in test files and run `npm run test:headless`
- Monitor test output for specific error patterns and mock setup issues

### Performance Considerations
- Large file handling: Consider chunking for very large files
- Network timeouts: Implement retry logic for GitHub operations
- Memory usage: Monitor memory consumption during sync operations

## Extension Activation

The extension activates when a workspace contains `.secureNotes/wsIndex.json`, indicating an initialized secure notes repository. The activation process:

1. **Container Setup**: Initialize the dependency injection container using `ContainerBuilder`
2. **Service Registration**: Register core services, VS Code services, and storage providers
3. **Command Registration**: Register all extension commands with proper dependency injection
4. **UI Initialization**: Set up tree view providers for branches and index history
5. **Event Handlers**: Configure auto-sync and file watching events

## Contributing

### Development Setup
1. Clone the repository
2. Run `npm install`
3. Open in VS Code
4. Press F5 to launch extension development host

### Code Quality
- All code must pass ESLint checks
- Add tests for new functionality
- Update documentation for API changes
- Follow existing code patterns and conventions

### Pull Request Guidelines
- Include tests for new features
- Update relevant documentation
- Ensure all tests pass
- Follow conventional commit messages