# Secure Notes Sync - VS Code Extension

## Project Overview

**Purpose**: A Visual Studio Code extension for securely managing and synchronizing notes (or other files) with a GitHub repository using AES encryption and branch-based version control.

**Language**: TypeScript  
**Framework**: VS Code Extension API  
**Build System**: Webpack + TypeScript  
**Testing**: VS Code Test Framework  

## Key Features

- **Secure Sync**: Encrypt files with AES-256-CBC before syncing to GitHub
- **Branch Management**: Create and switch between branches for different development lines
- **Auto-Sync**: Optional sync on save or after periods of inactivity
- **AES Key Management**: Generate keys, retrieve from 1Password CLI, or manual input
- **Conflict Resolution**: Detect and resolve merge conflicts automatically
- **Tree View**: Visualize branches and historical indexes in the activity bar

## Project Structure

### Core Files
- `src/extension.ts` - Main extension entry point with command registration and activation logic
- `src/types.ts` - TypeScript interfaces for FileEntry, IndexFile, and other core types
- `src/spec.md` - Detailed technical specification (originally for S3, adapted for GitHub)

### Storage Layer
- `src/storage/IStorageProvider.ts` - Interface for storage providers
- `src/storage/GithubProvider.ts` - GitHub-based storage implementation
- `src/storage/LocalObjectManager.ts` - Local file encryption, indexing, and workspace management

### UI Components
- `src/BranchTreeViewProvider.ts` - Tree view provider for branch and index visualization
- `src/logger.ts` - Custom terminal-based logging with ANSI colors

### Configuration Files
- `package.json` - Extension manifest with commands, views, and configuration schema
- `webpack.config.js` - Build configuration for bundling
- `tsconfig.json` - TypeScript compiler configuration
- `eslint.config.mjs` - ESLint configuration with TypeScript rules

## Architecture Patterns

### Encryption Strategy
- **Algorithm**: AES-256-CBC with random IV per file
- **Key Management**: 64-character hex strings (32 bytes)
- **Storage**: Encrypted files stored in `.secureNotes/remotes/files/` with hash-based paths

### Version Control Model
- **Index Files**: JSON structures with UUID v7, parent references, and file metadata
- **Branch References**: Encrypted UUID pointers stored in `.secureNotes/remotes/refs/`
- **Workspace Index**: `wsIndex.json` tracks current workspace state
- **HEAD File**: `.secureNotes/HEAD` stores current branch name

### File Organization
```
.secureNotes/
├── HEAD                           # Current branch name
├── wsIndex.json                   # Current workspace index
└── remotes/
    ├── refs/                      # Branch references (encrypted UUIDs)
    ├── indexes/                   # Encrypted index files (UUID-based paths)
    └── files/                     # Encrypted file content (hash-based paths)
```

## Development Guidelines

### Code Style
- Use TypeScript strict mode
- Follow ESLint rules defined in `eslint.config.mjs`
- Use Prettier for formatting (2-space indentation, semicolons)
- Prefer `async/await` over Promises

### Error Handling
- Use the logger module for consistent error reporting
- Show user-friendly error messages via `showError()` function
- Log detailed error information for debugging

### VS Code Extension Patterns
- Register commands in `activate()` function
- Use `context.subscriptions.push()` for proper cleanup
- Leverage VS Code's workspace API for file operations
- Use secrets API for sensitive data (AES keys)

### Storage Conventions
- Hash-based file paths: first 2 characters as directory, remainder as filename
- UUID-based index paths: first 6 characters as directory, remainder as filename
- Always encrypt sensitive data before storage
- Use relative paths for workspace files

## Configuration Schema

### Required Settings
- `SecureNotesSync.gitRemoteUrl` - GitHub repository URL (e.g., `git@github.com:user/repo.git`)

### Optional Settings
- `SecureNotesSync.enableAutoSync` - Enable automatic sync (default: false)
- `SecureNotesSync.inactivityTimeoutSec` - Auto-sync timeout (default: 60)
- `SecureNotesSync.saveSyncTimeoutSec` - Delay after save before sync (default: 5)
- `SecureNotesSync.onePasswordUri` - 1Password CLI URI for key retrieval
- `SecureNotesSync.onePasswordAccount` - 1Password account name
- `SecureNotesSync.onePasswordCacheTimeout` - Key cache duration (default: "30d")

## Commands Available

### Core Operations
- `extension.generateAESKey` - Generate new 32-byte AES key
- `extension.setAESKey` - Manually set AES key
- `extension.syncNotes` - Manual sync with GitHub
- `extension.refreshAESKey` - Force refresh from 1Password

### Utility Commands
- `extension.copyAESKeyToClipboard` - Copy current key to clipboard
- `extension.insertCurrentTime` - Insert timestamp in active editor

### Branch Management
- `extension.createBranchFromIndex` - Create new branch from selected index
- `extension.checkoutBranch` - Switch to selected branch

## Testing Strategy

### Test Files
- `src/test/extension.test.ts` - Main extension tests
- Use VS Code Test Runner for execution
- Test files must match pattern `**.test.ts`

### Test Commands
```bash
npm run compile-tests    # Compile test files
npm run pretest         # Run linting and compilation
npm run test            # Execute tests
```

## Build and Development

### Development Workflow
```bash
npm install             # Install dependencies
npm run compile         # Build for development
npm run watch           # Watch mode for development
F5                      # Launch extension in new VS Code window
```

### Production Build
```bash
npm run package         # Build optimized bundle
npm run vscode:prepublish # Prepare for publishing
```

### Dependencies
- **Runtime**: `uuid`, `which`
- **Development**: TypeScript, Webpack, ESLint, VS Code types

## Security Considerations

### Key Management
- Never log or expose AES keys in plain text
- Use VS Code secrets API for secure storage
- Support 1Password CLI integration for enterprise environments
- Implement key caching with configurable timeouts

### File Encryption
- Generate random IV for each file encryption
- Use SHA-256 for file integrity verification
- Encrypt all sensitive data before GitHub storage

### Git Integration
- Use SSH keys for GitHub authentication
- Never commit unencrypted sensitive data
- Implement proper conflict resolution strategies

## Troubleshooting

### Common Issues
- **AES Key not set**: Run "Generate AES Key" or "Set AES Key" command
- **Git remote not configured**: Set `gitRemoteUrl` in extension settings
- **1Password CLI issues**: Ensure `op` is in PATH and properly authenticated
- **Sync conflicts**: Extension automatically resolves with conflict file creation

### Debug Information
- Check the "SecureNoteSync Log" terminal for detailed logs
- Use VS Code Developer Tools for extension debugging
- Verify `.secureNotes` directory structure and permissions

## Extension Activation

The extension activates when a workspace contains `.secureNotes/wsIndex.json`, indicating an initialized secure notes repository.