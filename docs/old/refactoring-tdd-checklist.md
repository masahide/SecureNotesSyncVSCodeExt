# DRY リファクタリング TDD チェックリスト

- [x] WorkspaceContext サービスで ViewProvider からの `LocalObjectManager` 初期化重複を解消する
  - [x] Red: `BranchTreeViewProvider` と `IndexHistoryProvider` 向けの DI モックで既存直接生成が残っていることを検出するユニットテストを追加
  - [x] Green: DI 経由で `LocalObjectManager` を受け取る実装に置き換え、テストをパスさせる
  - [x] Refactor: サービスロケータ登録処理を共通化し、関連する手動 new 呼び出しを削除
- [x] AES キー取得の単一化
  - [x] Red: ViewProvider 側が `getAESKey` を利用しない場合に警告するテスト（モック `getAESKey` の呼び出し検証）を追加
  - [x] Green: `IndexHistoryProvider` 等で `getAESKey` を注入し、テストを成功させる
  - [x] Refactor: `getAESKey` 周辺のキャッシュロジックを小さなユーティリティに切り出し、共通経路で利用
- [x] `normalizeIndexFile` ヘルパー導入
  - [x] Red: `loadWsIndex`/`loadRemoteIndex`/`loadIndex` のいずれかから正規化が外れた際に検出するユニットテストを追加
  - [x] Green: 新しいヘルパー経由で正規化とソートを一箇所に集約し、テストをパスさせる
  - [x] Refactor: 既存メソッドから重複コードを削除し、型や戻り値の共有ユーティリティを整える
- [x] コンフリクトファイル名生成ロジックの共通化
  - [x] Red: 異なるコンフリクト関数が異なるフォーマットを返した場合に失敗するユニットテストを追加
  - [x] Green: `buildConflictFilePath` ヘルパーを導入し、両メソッドで利用する
  - [x] Refactor: タイムスタンプフォーマットをテスト可能なユーティリティに抽出し、ドキュメント化
- [x] Git ブランチ同期フローの共通化
  - [x] Red: `download` と `pullRemoteChanges` の手順差異を検知する統合テストを用意
  - [x] Green: 共有メソッド（例: `syncBranchFromRemote`）を実装し、両エントリーポイントから利用してテストを通す
  - [x] Refactor: ログメッセージとエラーハンドリングを共通化し、重複ヘルパーを削除
- [x] 自動同期設定取得の共通化
  - [x] Red: `setupAutoSyncListeners` が `config.ts` のヘルパーを経由しない場合に失敗するテストを追加
  - [x] Green: 設定取得を `config.isAutoSyncEnabled` 等に切り替え、テストをパスさせる
  - [x] Refactor: 将来の設定項目追加に備え、設定アクセスを小さなモジュールに集約
